<script>
document.addEventListener('DOMContentLoaded', () => {
    const vehicleList = document.getElementById('vehicleList');
    const loadMoreBtn = document.getElementById('loadMore');
    let skip = 0;

    async function fetchData() {
        try {
            const response = await fetch(`/api/vehicles?skip=${skip}`);
            const data = await response.json();
            return data.vehicles;
        } catch (error) {
            console.error(error);
        }
    }

    async function getImages(userId, vehicleId) {
        // Construct the image URL based on the provided format
        const imageUrl = `https://myqucckt.s3.ap-south-1.amazonaws.com/${userId}_${vehicleId}_`;

        // Assuming the images are numbered sequentially from 0
        const images = [];
        let index = 0;
        let imageUrlIndex = imageUrl + index;

        // Loop until no more images are found
        while (true) {
            // Try to fetch the image
            const response = await fetch(imageUrlIndex);
            if (response.ok) {
                // If the image exists, add it to the images array
                images.push(imageUrlIndex);
                index++;
                imageUrlIndex = imageUrl + index;
            } else {
                // If the image does not exist, break the loop
                break;
            }
        }

        return images;
    }

    async function renderData() {
        const vehicles = await fetchData();
        if (vehicles.length === 0) {
            loadMoreBtn.disabled = true;
            return;
        }

        for (const vehicle of vehicles) {
            const vehicleDiv = document.createElement('div');
            vehicleDiv.classList.add('vehicle');
            const images = await getImages(vehicle.userId, vehicle.vid);

            // Create a carousel for each vehicle
            vehicleDiv.innerHTML = `
                <h2>${vehicle.title}</h2>
                <div id="carousel${vehicle.vid}" class="carousel slide" data-ride="carousel">
                    <div class="carousel-inner">
                        ${images.map((image, index) => `
                            <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                <img src="${image}" class="d-block w-100" alt="Image ${index + 1}">
                            </div>
                        `).join('')}
                    </div>
                    <a class="carousel-control-prev" href="#carousel${vehicle.vid}" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#carousel${vehicle.vid}" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
                <p><strong>Vehicle ID:</strong> ${vehicle.vid}</p>
                <p><strong>Year:</strong> ${vehicle.year}</p>
                <p><strong>Registered Year:</strong> ${vehicle.regYear}</p>
                <p><strong>Mileage:</strong> ${vehicle.mileage}</p>
                <p><strong>Location:</strong> ${vehicle.location}</p>
                <p><strong>Price:</strong> ${vehicle.price}</p>
            `;
            vehicleList.appendChild(vehicleDiv);
        }

        skip += 10;
    }

    loadMoreBtn.addEventListener('click', renderData);

    renderData(); // Initial data load
});
</script>